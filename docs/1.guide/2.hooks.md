---
icon: material-symbols-light:data-object
---

# Hooks

> Using hooks, you can define a WebSocket server that works across runtimes with the same syntax.

Crossws provides a cross-platform API to define WebSocket servers. An implementation with these hooks works across runtimes without needing you to go into details of each of them. You only define the life-cycle hooks that you only need.

> [!TIP]
> Using `defineHooks()` wrapper is optional and for type support and code auto completion.

```ts
import { defineHooks } from "crossws";

const hooks = defineHooks({
  upgrade(request) {
    console.log(`[ws] upgrading ${request.url}...`);
    return {
      headers: {},
    };
  },

  open(peer) {
    console.log(`[ws] open: ${peer}`);
  },

  message(peer, message) {
    console.log("[ws] message", peer, message);
    if (message.text().includes("ping")) {
      peer.send("pong");
    }
  },

  close(peer, event) {
    console.log("[ws] close", peer, event);
  },

  error(peer, error) {
    console.log("[ws] error", peer, error);
  },
});
```

## Context

You can store data in the `context` property of the `request` object during the `upgrade` hook or the `peer` object during the other hooks. This data will be shared in all hooks for the lifetime of the connection.

> [!NOTE]
> context can be volatile in some environments like `cloudflare-durable`

```ts
import { defineHooks } from "crossws";

const hooks = defineHooks({
  upgrade(request) {
    request.context.data = "myData";
  },

  open(peer) {
    console.log(peer.context.data); // myData
  },

  message(peer, message) {
    console.log(peer.context.data); // myData
  },

  close(peer, details) {
    console.log(peer.context.data); // myData
  },
});
```

## Authentication

During the `upgrade` hook it is possible to authenticate the user before upgrading the connection. If the user is not authenticated, you can throw a [`Response`](https://developer.mozilla.org/en-US/docs/Web/API/Response) **as error** to prevent the connection from being upgraded.

```ts
import { defineHooks } from "crossws";

const authToken = "Bearer myToken123";

const hooks = defineHooks({
  upgrade(request) {
    const authHeader = request.headers.get("Authorization");

    if (!authHeader || !authHeader.startsWith("Basic ")) {
      return new Response("Unauthorized", {
        status: 401,
        headers: {
          "WWW-Authenticate":
            'Basic realm="Websocket Authentication", charset="UTF-8"',
        },
      });
    }

    const base64Credentials = authHeader.split(" ")[1];
    const [username, password] = atob(base64Credentials).split(":");

    if (username !== "myUsername" || password !== "myPassword") {
      return new Response("Unauthorized", {
        status: 401,
        headers: {
          "WWW-Authenticate":
            'Basic realm="Websocket Authentication", charset="UTF-8"',
        },
      });
    }

    return {
      headers: {}, // Optionally return custom headers
    };
  },
});
```
